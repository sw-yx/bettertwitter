import { derived, writable } from 'svelte/store';

const defaultSettings = {
  filters: {
    replies: 'filterOut',
    retweets: 'filterOut'
  }
}
const localStorageKey = "filters"
let storedSettings = localStorage.getItem(localStorageKey);
storedSettings = storedSettings ? JSON.parse(storedSettings) : defaultSettings
export const settings = writable(storedSettings);

settings.subscribe(value => {
  localStorage.setItem(localStorageKey, JSON.stringify(value));
});

export const tweetURL = derived(settings, obj => {
  let final = ''
  let header = 'https://mobile.twitter.com'
  Object.keys(obj).forEach(k => {
    if (k === 'filters') return
    if (k === 'searchKeyword') {
      // special
      final = final.concat(obj[k] || '').concat(' ')
    } else if (obj[k]) {
      final = final.concat(`${k}:${obj[k]} `)
    }
  })
  Object.entries(obj.filters).forEach(([filter, filterState]) => {
    if (filterState === 'filterFor') final = final.concat(`filter:${filter} `)
    // if (filterState === 'filterOut') final = final.concat(`!filter:${filter} `) // seems to have changed
    if (filterState === 'filterOut') final = final.concat(`-filter:${filter} `)
  })
  if (obj.seeFollow) {
    delete obj.seeFollow
    final = final.concat(`filter:follows `)
    header = 'https://mobile.twitter.com'
  }
  if (obj.minLikes > 0) final = final.concat(`min_faves:${obj.minLikes} `)
  if (obj.minRTs > 0) final = final.concat(`min_retweets:${obj.minRTs} `)
  // return `https://mobile.twitter.com/search?src=typd&f=live&q=${encodeURIComponent(final)}`
  return `${header}/search?f=tweets&q=${encodeURIComponent(final)}`
})